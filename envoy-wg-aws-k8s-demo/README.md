# Envoy VPN Proxy Demo

A demonstration of secure PostgreSQL connectivity from Kubernetes to an AWS private subnet using Envoy TCP proxy and WireGuard VPN tunnel.

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Kubernetes Cluster                                                              │
│                                                                                 │
│  ┌──────────────────────────────┐       ┌──────────────────────────────────┐   │
│  │ psql-client Pod              │       │ wireguard-client Pod             │   │
│  │                              │       │                                  │   │
│  │  ┌────────┐    ┌───────┐    │       │  ┌───────┐    ┌────────────────┐ │   │
│  │  │  psql  │───▶│ Envoy │────┼───────┼─▶│ Envoy │───▶│ WireGuard      │─┼───┼──┐
│  │  │ client │    │:5432  │    │       │  │:15432 │    │ Client (wg0)   │ │   │  │
│  │  └────────┘    └───────┘    │       │  └───────┘    └────────────────┘ │   │  │
│  │                              │       │                                  │   │  │
│  └──────────────────────────────┘       └──────────────────────────────────┘   │  │
│                                                                                 │  │
└─────────────────────────────────────────────────────────────────────────────────┘  │
                                                                                      │
                                        UDP 51820 (WireGuard Tunnel)                  │
                                                                                      │
┌─────────────────────────────────────────────────────────────────────────────────┐  │
│ AWS VPC (10.0.0.0/16)                                              us-east-1    │  │
│                                                                                 │  │
│  ┌─────────────────────────────────┐   ┌─────────────────────────────────────┐ │  │
│  │ Public Subnet (10.0.1.0/24)     │   │ Private Subnet (10.0.2.0/24)        │ │  │
│  │                                 │   │                                     │ │  │
│  │  ┌───────────────────────────┐  │   │  ┌─────────────────────────────┐   │ │  │
│  │  │ EC2: WireGuard Server     │◀─┼───┼──│ EC2: PostgreSQL Server      │   │ │  │
│  │  │                           │  │   │  │                             │   │ │  │
│  │  │ - Public IP (Elastic IP)  │  │   │  │ - Private IP only           │   │ │  │
│  │  │ - wg0: 10.8.0.1/24        │  │   │  │ - PostgreSQL on :5432       │   │ │  │
│  │  │ - NAT + forwarding        │  │   │  │ - Credentials from SSM      │   │ │  │
│  │  └───────────────────────────┘  │   │  └─────────────────────────────┘   │ │  │
│  │              ▲                  │   │                                     │ │  │
│  └──────────────┼──────────────────┘   └─────────────────────────────────────┘ │  │
│                 │                                                               │  │
└─────────────────┼───────────────────────────────────────────────────────────────┘  │
                  └──────────────────────────────────────────────────────────────────┘
```

## Data Flow

1. **psql client** connects to `localhost:5432`
2. **Envoy sidecar** (in psql-client pod) proxies TCP to `wireguard-client-svc:15432`
3. **Envoy sidecar** (in wireguard-client pod) proxies TCP to PostgreSQL private IP
4. Traffic routes through **WireGuard tunnel** (wg0 interface) to AWS
5. **WireGuard server** in public subnet forwards to **PostgreSQL** in private subnet
6. Response returns via the same path

## Components

### AWS Infrastructure (Terraform)

| Component | Description |
|-----------|-------------|
| VPC | 10.0.0.0/16 with public and private subnets |
| WireGuard EC2 | t4g.nano in public subnet, also acts as NAT instance for private subnet |
| PostgreSQL EC2 | t4g.nano in private subnet (routes internet via WireGuard) |
| SSM Parameters | Secure storage for WireGuard keys and PostgreSQL credentials |
| IAM Role | EC2 instance profile for SSM parameter access |

### Kubernetes

| Component | Description |
|-----------|-------------|
| wireguard-client | WireGuard client + Envoy sidecar deployment |
| psql-client | PostgreSQL client + Envoy sidecar deployment |
| wireguard-client-svc | ClusterIP service exposing Envoy on port 15432 |

### Security

- WireGuard keys generated by Terraform, stored in AWS SSM Parameter Store
- PostgreSQL password randomly generated, stored in SSM Parameter Store
- EC2 instances fetch secrets from SSM at boot (no secrets in user data)
- Private subnet routes through WireGuard server (NAT instance, no NAT Gateway cost)
- No SSH ports open, instance access via SSM Session Manager
- All resources tagged with project name

## Prerequisites

- AWS CLI configured with appropriate permissions
- AWS Session Manager plugin (for EC2 access)
- Terraform >= 1.0
- kubectl with access to a Kubernetes cluster
- jq (for parsing terraform outputs)

## Setup

### 1. Deploy AWS Infrastructure

```bash
cd terraform
terraform init
terraform plan
terraform apply
```

This creates:
- VPC with public/private subnets
- WireGuard server EC2 (auto-configured via user data)
- PostgreSQL server EC2 (auto-configured via user data)
- SSM parameters with generated secrets

### 2. Generate Kubernetes Configs

After Terraform completes, generate the Kubernetes configuration files:

```bash
./scripts/generate-k8s-secrets.sh
```

This creates (gitignored):
- `k8s/base/secrets/wg0.conf` - WireGuard client configuration
- `k8s/base/secrets/postgres.env` - PostgreSQL credentials
- `k8s/base/secrets/psql-envoy.yaml` - Envoy config for psql-client
- `k8s/base/secrets/wg-envoy.yaml` - Envoy config for wireguard-client

### 3. Deploy to Kubernetes

```bash
kubectl apply -k k8s/
```

### 4. Verify Deployment

Check pods are running:
```bash
kubectl -n psql-envoy-demo get pods
```

Check WireGuard tunnel is established:
```bash
kubectl -n psql-envoy-demo exec -it deployment/wireguard-client -c wireguard -- wg show
```

### 5. Test PostgreSQL Connection

```bash
kubectl -n psql-envoy-demo exec -it deployment/psql-client -c psql -- psql
```

If successful, you'll get a PostgreSQL prompt connected through the entire chain:
```
psql (16.x)
Type "help" for help.

demodb=>
```

## Troubleshooting

### Check WireGuard Server

```bash
aws ssm start-session --target $(cd terraform && terraform output -raw wireguard_instance_id)
sudo wg show
```

### Check PostgreSQL Server

```bash
aws ssm start-session --target $(cd terraform && terraform output -raw postgresql_instance_id)
sudo -u postgres psql -c "SELECT 1"
```

### View Envoy Logs

```bash
kubectl -n psql-envoy-demo logs deployment/psql-client -c envoy
kubectl -n psql-envoy-demo logs deployment/wireguard-client -c envoy
```

## Cleanup

```bash
# Remove Kubernetes resources
kubectl delete -k k8s/

# Remove generated secrets
rm -rf k8s/base/secrets/

# Destroy AWS infrastructure
cd terraform
terraform destroy
```
